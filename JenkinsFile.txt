pipeline {
    agent any

    options {
        // Enable build retention to keep build history
        buildDiscarder(logRotator(numToKeepStr: '10'))
    }

    triggers {
        // Run on pull request to branch
        pullRequest {
            branchTargetBranch = 'master'
            triggerPhrase = 'run tests'
        }
        // Run on schedule (every day at 8am)
        cron('0 8 * * *')
        // Run by manual start
        }
    
    parameters {
        // Parameter to select browser for UI tests
        choice(
            name: 'BROWSER',
            choices: ['Chrome', 'Firefox', 'Safari'],
            description: 'Select browser to run UI tests against'
        )
    }

    stages {
        stage('API Tests') {
            steps {
                // Use MSBuild to build the solution
                bat "MSBuild.exe /p:Configuration=Release ATM_Test_Automation_Framework.sln"
                // Use NUnit console to run API tests
                bat "nunit3-console.exe Tests/bin/Release/Tests.dll --where \"cat==API\""
            }
            post {
                // Archive the test results
                junit 'Tests/bin/Release/ATM_Test_Automation_Framework.Tests.XML'
            }
        }
        stage('UI Tests') {
            when {
                // Run UI tests only if API tests pass
                allOf {
                    not {
                        failed()
                    }
                    expression {
                        params.BROWSER != null
                    }
                }
            }
            steps {
                // Use NUnit console to run UI tests with selected browser
                bat "nunit3-console.exe Tests/bin/Release/Tests.dll --where \"cat==UI\" --params:Browser=${params.BROWSER}"
            }
            post {
                // Archive the test results and screenshots
                junit 'Tests/bin/Release/ATM_Test_Automation_Framework.Tests.XML'
                archiveArtifacts 'Tests/screenshots/*.png'
            }
        }
    }
}
